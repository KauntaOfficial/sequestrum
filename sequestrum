#!/usr/bin/env python3
#
# Sequestrum - Dotfile Manager

# Libraries
import sys
import yaml
from pathlib import Path

homePath = str(Path.home()) + "/"
sys.path.insert(0, homePath + "/Sequestrum/Modules")

# Modules
import directoryModule as dirMod
import symlinkModule as symMod
import argumentsModule as argMod
import commandsModule as comMod

# Grab user inputted arguments from the module and make sure they entered some.
arguments = argMod.getArguments()

if arguments == None:
    print("Sequestrum: Must enter arguments")
    sys.exit()

# Creates a new directory. It creates a new folder path using the config
# then creates a new folder using that path. It then loops through each
# link in the links list and **copies** (not symlinking) the original file
# on the source system over to the dotfiles.


def setupDirectory(directoryKey):
    """
        Setup package directory on dotfile
    """
    # Make a path for the new directory path using the name specified in the
    # config then make the folder using the path.
    newDirectoryPath = dotfilePath + \
        configDict['options'][directoryKey]['directoryName'] + "/"
    dirMod.createFolder(newDirectoryPath)

    for link in configDict['options'][directoryKey]['links']:
        for key, value in link.items():
            sourceFile = homePath + value
            destFile = newDirectoryPath + key

            if symMod.symlinkSourceExists(sourceFile):
                if dirMod.isFolder(sourceFile):
                    symMod.copyFolder(sourceFile, destFile)
                elif dirMod.isFile(sourceFile):
                    symMod.copyFile(sourceFile, destFile)
                else:
                    return False
            else:
                return False
    return True


# Grabs the directory of the key. For each item in the dotfile directory,
# properly symlink the file to the right place. If the file on the local
# system already exists. Delete the existing file before symlinking to
# prevent issues.


def installDirectory(directoryKey):
    """
        Install package to local system
    """
    # Grab dotfile package directory
    directoryPath = dotfilePath + \
        configDict['options'][directoryKey]['directoryName'] + "/"

    # Loop through files to link
    for link in configDict['options'][directoryKey]['links']:
        # Symlink files to local files
        for key, value in link.items():
            sourceFile = directoryPath + key
            destFile = homePath + value

            # Make sure file exists in dotfiles
            if symMod.symlinkSourceExists(sourceFile):
                if dirMod.isFolder(sourceFile):
                    symMod.createSymlink(sourceFile, destFile)
                elif dirMod.isFile(sourceFile):
                    symMod.createSymlink(sourceFile, destFile)
                else:
                    return False
            else:
                return False
    return True


configFile = open("config.yaml", "r")
configDict = yaml.load(configFile)
directoryList = []

# Grab list of directories from the config.
for key, value in configDict['options'].items():
    if key.endswith("Directory"):
        directoryList.append(key[:-9])

# Grab the path of the dotfile directory
dotfilePath = homePath + \
    configDict['options']['base']['dotfileDirectory'] + "/"

# Setups up the dotfiles accordingly to the config. This should only be
# ran once to setup your dotfiles with the right directories. After this,
# users should use the update argument to update their dotfiles with new
# packages.
if arguments[0] == "Setup":
    if arguments[1] == "all":
        for key, value in configDict['options'].items():
            if key.endswith("Package"):
                if "commandsBefore" in value:
                    comMod.runCommands(
                        configDict['options'][key]["commandsBefore"])
                setupDirectory(key)
                if "commandsAfter" in value:
                    comMod.runCommands(
                        configDict['options'][key]["commandsBefore"])
    else:
        print("Valid Usage: sequestrum -s")

# Install the files from the dotfiles. Symlinks the files from the
# specified packages to the local system files. If the file or folder
# already exists on the local system, delete it then symlink properly to
# avoid errors.
elif arguments[0] == "Install":
    # Install all packages
    if arguments[1] == "all":
        for key, value in configDict['options'].items():
            if key.endswith("Package"):
                if "commandsBefore" in value:
                    comMod.runCommands(
                        configDict['options'][key]["commandsBefore"])
                dirMod.installDirectory(key)
                if "commandsAfter" in value:
                    comMod.runCommands(
                        configDict['options'][key]["commandsBefore"])

    # The option to only install one package instead of all your dotfiles.
    elif arguments[1] in directoryList:
        for key, value in configDict['options'].items():
            if key == arguement[1] + "Package":
                if "commandsBefore" in value:
                    comMod.runCommands(
                        configDict['options'][key]["commandsBefore"])
                dirMod.installDirectory(key)
                if "commandsAfter" in value:
                    comMod.runCommands(
                        configDict['options'][key]["commandsBefore"])
    else:
        print("Invalid Directory")
elif arguments[0] in {"-u", "--unlink"}:
    if arguments[1] == "all":
        print("PLACEHOLDER")
    elif arguments[1] in directoryList:
        print("PLACEHOLDER")
    else:
        print("PLACEHOLDEr")
else:
    print("Invalid Command")
